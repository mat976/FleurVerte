{% extends 'base.html.twig' %}

{% block title %}
	{{ fleur.nom }}
	- FleurVerte
{% endblock %}

{% block body %}
<div class="container mx-auto px-4 mt-8">
	<div class="bg-white shadow-lg rounded-lg overflow-hidden">
		<div class="md:flex">
			<div class="md:w-1/2">
				<img src="{{ asset(fleur.getImageUrl()) }}" alt="{{ fleur.nom }}" class="w-full h-96 object-cover rounded-lg shadow-md">
			</div>
			<div class="md:w-1/2 p-8">
				<div class="flex justify-between items-start mb-4">
					<h1 class="text-3xl font-bold">{{ fleur.nom }}</h1>
					<span class="px-3 py-1 text-sm font-semibold rounded-full ml-4
							                            {% if fleur.stockStatus == 'out_of_stock' %}
							                                bg-red-100 text-red-800
							                            {% elseif fleur.stockStatus == 'low_stock' %}
							                                bg-orange-100 text-orange-800
							                            {% elseif fleur.stockStatus == 'medium_stock' %}
							                                bg-yellow-100 text-yellow-800
							                            {% elseif fleur.stockStatus == 'in_stock' %}
							                                bg-green-100 text-green-800
							                            {% else %}
							                                bg-gray-100 text-gray-800
							                            {% endif %}">
						{{ fleur.stockLabel }}
					</span>
				</div>

				<p class="text-gray-600 mb-4">{{ fleur.description }}</p>

				<!-- Tags de la fleur -->
				{% if fleur.tags|length > 0 %}
					<div class="mb-4">
						<h3 class="text-sm font-medium text-gray-700 mb-2">Tags:</h3>
						<div class="flex flex-wrap gap-2">
							{% for tag in fleur.tags %}
								<a href="{{ path('app_search', {'tag': tag.id}) }}" class="inline-block px-3 py-1 rounded-full text-sm font-semibold hover:tag-selected transition-all duration-300" style="background-color: {{ tag.couleur }}; color: {{ tag.textColor }}">
									{{ tag.nom }}
								</a>
							{% endfor %}
						</div>
					</div>
				{% endif %}

				<div class="flex items-center justify-between mb-6">
					<span class="text-2xl font-bold text-green-600">{{ fleur.prix }}
						‚Ç¨</span>
					<div class="text-gray-500">
						<span class="font-semibold">Stock:</span>
						<span>{{ fleur.stock }}</span>
					</div>
				</div>

				<div class="mt-6">
					<a href="{{ path('app_cart_add', {'id': fleur.id}) }}" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
						Ajouter au panier
					</a>
				</div>

				{# Note moyenne #}
				<div class="mt-6 p-4 bg-gray-50 rounded-lg">
					<div class="flex items-center gap-2">
						<span class="text-lg font-semibold">Note moyenne:</span>
						{% if fleur.noteMoyenne is not null %}
							<div class="flex items-center">
								{% for i in 1..5 %}
									{% if i <= fleur.noteMoyenne %}
										<span class="text-yellow-400 text-xl">‚òÖ</span>
									{% else %}
										<span class="text-gray-300 text-xl">‚òÖ</span>
									{% endif %}
								{% endfor %}
								<span class="ml-2 text-gray-600">({{ fleur.noteMoyenne }}/5 - {{ fleur.nombreCommentaires }} avis)</span>
							</div>
						{% else %}
							<span class="text-gray-500">Aucun avis pour le moment</span>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	{# Section Commentaires #}
	<div class="mt-8 bg-white shadow-lg rounded-lg p-6">
		<h2 class="text-2xl font-bold mb-6">Avis et commentaires</h2>

		{# Formulaire de commentaire #}
		{% if app.user %}
			<div class="mb-8 p-4 bg-gray-50 rounded-lg">
				<h3 class="text-lg font-semibold mb-4">Laisser un avis</h3>
				{{ form_start(commentaireForm, {'attr': {'class': 'space-y-4'}}) }}
					<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
						<div>
							{{ form_label(commentaireForm.note, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700 mb-1'}}) }}
							{{ form_widget(commentaireForm.note) }}
							{{ form_errors(commentaireForm.note) }}
						</div>
						<div class="md:col-span-3">
							{{ form_label(commentaireForm.contenu, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700 mb-1'}}) }}
							{{ form_widget(commentaireForm.contenu) }}
							{{ form_errors(commentaireForm.contenu) }}
						</div>
					</div>
					<button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
						Publier mon avis
					</button>
				{{ form_end(commentaireForm) }}
			</div>
		{% else %}
			<div class="mb-8 p-4 bg-blue-50 rounded-lg text-center">
				<p class="text-gray-700">
					<a href="{{ path('app_login') }}" class="text-blue-600 hover:underline font-semibold">Connectez-vous</a> pour laisser un avis.
				</p>
			</div>
		{% endif %}

		{# Liste des commentaires #}
		{% if fleur.commentaires|length > 0 %}
			<div class="space-y-4">
				{% for commentaire in fleur.commentaires %}
					<div class="border-b border-gray-200 pb-4 {% if not loop.last %}mb-4{% endif %}">
						<div class="flex justify-between items-start">
							<div class="flex items-center gap-3">
								<div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
									{{ commentaire.user.username|first|upper }}
								</div>
								<div>
									<p class="font-semibold">{{ commentaire.user.username }}</p>
									<p class="text-sm text-gray-500">{{ commentaire.dateCreation|date('d/m/Y √† H:i') }}</p>
								</div>
							</div>
							<div class="flex items-center gap-2">
								<div class="flex">
									{% for i in 1..5 %}
										{% if i <= commentaire.note %}
											<span class="text-yellow-400">‚òÖ</span>
										{% else %}
											<span class="text-gray-300">‚òÖ</span>
										{% endif %}
									{% endfor %}
								</div>
								<span class="text-sm text-gray-600">({{ commentaire.note }}/5)</span>
							</div>
						</div>
						<p class="mt-3 text-gray-700">{{ commentaire.contenu }}</p>
						
						{# Bouton supprimer pour le propri√©taire ou admin #}
						{% if app.user and (app.user == commentaire.user or is_granted('ROLE_ADMIN')) %}
							<form action="{{ path('commentaire_delete', {'id': commentaire.id}) }}" method="post" class="mt-2">
								<button type="submit" class="text-red-600 hover:text-red-800 text-sm" onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer ce commentaire ?')">
									üóëÔ∏è Supprimer
								</button>
							</form>
						{% endif %}
					</div>
				{% endfor %}
			</div>
		{% else %}
			<p class="text-gray-500 text-center py-8">Aucun avis pour le moment. Soyez le premier √† donner votre avis !</p>
		{% endif %}
	</div>
</div>
{% endblock %}
